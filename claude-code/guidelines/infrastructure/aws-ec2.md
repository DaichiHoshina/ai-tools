# AWS EC2 ガイドライン

**目的**: EC2 インスタンスの安全で効率的な設定管理

---

## terraform-aws-modules/ec2-instance

| 項目 | 設定値 |
|------|--------|
| `name` | 環境プレフィックス付き（`${var.environment}-web-server`） |
| `ami` | 最新の Amazon Linux 2023 推奨 |
| `instance_type` | ワークロードに応じて選択 |
| `subnet_id` | プライベートサブネット推奨 |

---

## 必須設定

### メタデータサービス (IMDS)

| 項目 | 設定 |
|------|------|
| IMDSv2 | `http_tokens = "required"` |
| ホップリミット | コンテナ使用時 `2`、それ以外 `1` |

### ストレージ

| 項目 | 設定 |
|------|------|
| `volume_type` | `gp3`（最新世代） |
| `encrypted` | `true`（必須） |
| `iops` / `throughput` | 必要に応じて設定 |

---

## インスタンスタイプ選択

| 用途 | 推奨タイプ |
|------|-----------|
| 汎用 | t3, m5, m6i（例: t3.medium, m5.xlarge） |
| コンピューティング | c5, c6i |
| メモリ最適化 | r5, r6i |
| ストレージ | i3, d2 |

### コスト最適化

| 方式 | 用途 |
|------|------|
| Spot | 耐障害性のあるワークロード |
| Reserved | 長期稼働する本番環境 |
| Savings Plans | 柔軟なコミットメント |

---

## セキュリティ

| ❌ 禁止事項 | ✅ 推奨事項 |
|------------|------------|
| パブリック IP 直接割り当て | ALB/NLB 経由を推奨 |
| SSH (22) を `0.0.0.0/0` に公開 | Systems Manager Session Manager 経由のアクセス |
| IMDSv1 の使用 | IMDSv2 必須 |
| 暗号化なしの EBS | 暗号化必須 |
| - | プライベートサブネットへの配置 |
| - | IAM インスタンスプロファイルの最小権限 |
| - | CloudWatch エージェントによる監視 |

---

## User Data

| 項目 | 内容 |
|------|------|
| べき等性 | 複数回実行しても同じ結果を保証 |
| エラーハンドリング | `set -e` で即座にエラー検出 |
| base64 | 必要時は `user_data_base64` 使用 |

---

## 監視とログ

| 項目 | 設定 |
|------|------|
| 詳細モニタリング | `monitoring = true` |
| CloudWatch エージェント | インストール必須 |
| ログ送信 | CloudWatch Logs へ送信 |

---

## タグ付け（必須）

| タグ | 用途 |
|------|------|
| `Name` | インスタンス名 |
| `Environment` | 環境名 |
| `Application` | アプリケーション名 |
| `Owner` | 所有チーム |
| `AutoShutdown` | 開発環境での自動停止フラグ |
