# ECサイト開発ガイドライン

> **目的**: プラットフォーム非依存のECサイト開発ベストプラクティス（Shopify / STORES / 自社開発など全てに適用可能）

---

## ドメインモデル

### コアエンティティ関係図

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Customer  │────▶│    Order    │────▶│  OrderItem  │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │   Payment   │     │   Product   │
                    └─────────────┘     └─────────────┘
                                              │
                                              ▼
                                        ┌─────────────┐
                                        │   Variant   │
                                        └─────────────┘
```

### エンティティ定義

| エンティティ | 主要属性 | 責務 |
|-------------|---------|------|
| Customer | email, name, addresses | 顧客情報管理 |
| Product | title, description, images | 商品マスタ |
| Variant | sku, price, inventory | 商品バリエーション（サイズ・色） |
| Cart | items, totals | 買い物かご |
| Order | status, items, shipping | 注文管理 |
| Payment | method, status, amount | 決済管理 |

---

## 機能要件チェックリスト

### 🛒 商品管理

- [ ] 商品登録・編集・削除
- [ ] バリエーション管理（サイズ・色・素材）
- [ ] 在庫管理（リアルタイム更新）
- [ ] 在庫切れ表示・入荷通知
- [ ] 商品画像（複数・ズーム・360度）
- [ ] カテゴリ・タグ分類
- [ ] 検索・フィルタリング
- [ ] 関連商品・レコメンド

### 🛍️ カート・購入フロー

- [ ] カート追加・削除・数量変更
- [ ] カート保持（ログイン前後）
- [ ] クーポン・割引コード適用
- [ ] 送料計算（地域・重量・金額別）
- [ ] ギフト設定（のし・ラッピング）
- [ ] 配送日時指定
- [ ] 複数配送先対応

### 💳 決済

- [ ] クレジットカード
- [ ] コンビニ払い
- [ ] 銀行振込
- [ ] 後払い（Paidy等）
- [ ] 電子マネー（PayPay等）
- [ ] 代引き
- [ ] 定期購入（サブスクリプション）

### 👤 顧客管理

- [ ] 会員登録・ログイン
- [ ] ソーシャルログイン
- [ ] パスワードリセット
- [ ] 住所帳管理
- [ ] 注文履歴
- [ ] お気に入り・ウィッシュリスト
- [ ] ポイント・マイレージ
- [ ] 会員ランク

### 📦 注文・配送

- [ ] 注文確認メール
- [ ] 発送通知メール
- [ ] 配送状況追跡
- [ ] 注文キャンセル
- [ ] 返品・返金処理
- [ ] 部分発送対応

### 📊 運営・分析

- [ ] 売上ダッシュボード
- [ ] 在庫アラート
- [ ] 顧客分析（RFM等）
- [ ] コンバージョン追跡
- [ ] A/Bテスト

---

## 非機能要件

### パフォーマンス

| 指標 | 目標値 |
|------|--------|
| ページ読み込み | < 3秒（LCP） |
| 検索応答 | < 500ms |
| 決済処理 | < 5秒 |
| 同時接続 | 1000+ユーザー |

### 可用性

| 指標 | 目標値 |
|------|--------|
| 稼働率 | 99.9%（年間8.7時間以内のダウン） |
| RTO | < 1時間 |
| RPO | < 5分 |

### セキュリティ

- HTTPS強制（TLS 1.3）
- PCI DSS準拠（カード情報非保持）
- CSRF対策、XSS対策（サニタイズ）
- SQLインジェクション対策
- 認証（2FA推奨）、セッション管理（タイムアウト）
- 監査ログ

---

## 状態遷移

### 注文ステータス

```
[作成] → [支払待ち] → [支払済] → [発送準備中] → [発送済] → [配達完了]
                ↓           ↓            ↓
            [キャンセル]  [キャンセル]  [返品処理中] → [返品完了]
```

### 在庫ステータス

```
[在庫あり] ←→ [残りわずか] → [在庫切れ] → [入荷待ち] → [在庫あり]
                                ↓
                            [販売終了]
```

---

## 法令対応（日本）

### 必須ページ

- [ ] 特定商取引法に基づく表記（販売業者名、代表者名、所在地、電話番号、販売価格、送料、支払方法・時期、引き渡し時期、返品・交換条件）
- [ ] プライバシーポリシー
- [ ] 利用規約
- [ ] 会社概要

### データ保護

| 地域 | 法規制 | 要件 |
|------|--------|------|
| **日本** | 個人情報保護法、改正電気通信事業法 | Cookie同意 |
| **EU** | GDPR | データ削除権、同意取得 |
| **米国（CA）** | CCPA | オプトアウト権 |

---

## 技術設計パターン

### API設計（RESTful）

```
GET    /products          # 商品一覧
GET    /products/:id      # 商品詳細
POST   /cart/items        # カート追加
POST   /orders            # 注文作成
```

**ステータスコード**: 200（成功）, 201（作成）, 400（バリデーションエラー）, 401（認証エラー）, 402（決済エラー）, 409（在庫不足・競合）, 422（ビジネスロジックエラー）

### 在庫管理（楽観的ロック）

```typescript
// 在庫確保（楽観的ロック + version管理）
await db.variant.updateMany({
  where: { id, inventory: { gte: qty }, version },
  data: { inventory: { decrement: qty }, version: { increment: 1 } }
});
```

### 決済フロー

1. カート確定 → 在庫仮押さえ
2. 決済開始 → 決済サービス呼び出し
3. 決済成功 → 注文確定・在庫確定
4. 決済失敗/タイムアウト → 在庫解放・エラー表示（15分）

---

## 画像・メディア最適化

| 種類 | サイズ | 形式 | 備考 |
|------|--------|------|------|
| **商品画像（メイン）** | 1200x1200px | WebP（フォールバック: JPEG） | CDN配信 |
| **サムネイル** | 400x400px | WebP | `loading="lazy"` |
| **altテキスト** | - | - | 商品名 + バリエーション（例: "ホワイトTシャツ Lサイズ 正面"） |

---

## プラットフォーム別参考

| プラットフォーム | API・技術 | 備考 |
|-----------------|----------|------|
| **Shopify** | Storefront API / Admin GraphQL API, Hydrogen（ヘッドレス） | context7: `/websites/shopify_dev` |
| **STORES** | REST API, OAuth 2.0 | スタンダードプラン以上、[API Docs](https://heyinc.github.io/retail-api-docs/) |
| **自社開発** | Next.js / Remix, Stripe / GMO / PAY.JP, Algolia / Elasticsearch | フレームワーク・決済・検索を自由選択 |
