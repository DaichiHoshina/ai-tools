# マイクロサービス + Kubernetes ガイドライン

> **目的**: スケーラブルで保守性の高い分散システム設計

---

## 基本原則

| 原則 | 説明 | 実装ポイント |
|------|------|-------------|
| **単一責任** | 1サービス = 1ビジネス機能 | 注文、在庫、配送など機能で分割 |
| **独立デプロイ** | 他サービスに影響なく更新 | API契約で疎結合を維持 |
| **疎結合** | サービス間はAPI通信 | 直接DB参照禁止 |
| **データ所有** | 各サービスが独自DBを持つ | Database per Service |

---

## サービス設計

### 境界の決め方

| 観点 | 詳細 |
|------|------|
| **ビジネス機能** | 注文、在庫、配送など業務機能で分割 |
| **DDD境界** | ドメイン境界づけられたコンテキストと一致 |
| **チーム構成** | Conwayの法則に従う（1チーム1サービス） |

### サイズ判断

| パターン | 評価 | 理由 |
|----------|------|------|
| 小さすぎ | ❌ | 過度な通信オーバーヘッド |
| 大きすぎ | ❌ | モノリスに逆戻り |
| **適切** | ✅ | **1チームで管理可能なサイズ** |

---

## サービス間通信

### 通信方式

| 種類 | プロトコル | 用途 |
|------|-----------|------|
| **同期** | REST | シンプルなCRUD |
| **同期** | gRPC | 高パフォーマンス、型安全 |
| **非同期** | Kafka/RabbitMQ/SQS | イベント駆動、疎結合 |

### パターン

| パターン | 役割 |
|----------|------|
| **API Gateway** | 単一エントリポイント、ルーティング |
| **Service Mesh** | サービス間通信制御（Istio, Linkerd） |
| **Circuit Breaker** | 障害連鎖を防止 |

---

## データ管理

| パターン | 説明 |
|----------|------|
| **Database per Service** | 各サービスが独自DB所有、直接アクセス禁止 |
| **Saga** | 分散トランザクション管理 |
| **イベントソーシング** | イベントで状態管理 |
| **結果整合性** | 即座でなく最終的に整合 |

---

## Kubernetes 基本リソース

| リソース | 役割 | 補足 |
|----------|------|------|
| **Pod** | 最小デプロイ単位 | 1-2コンテナ（サイドカー含む） |
| **Deployment** | Podレプリカ管理 | ローリングアップデート |
| **Service** | - | ClusterIP/NodePort/LoadBalancer |
| **Ingress** | HTTP/HTTPSルーティング | TLS終端 |

---

## K8s ベストプラクティス

### リソース管理

```yaml
resources:
  requests: { cpu: 100m, memory: 128Mi }
  limits: { cpu: 500m, memory: 512Mi }
```

- HPA（Horizontal Pod Autoscaler）で自動スケール

### ヘルスチェック

| Probe | 用途 |
|-------|------|
| **livenessProbe** | 再起動判定 |
| **readinessProbe** | トラフィック受付判定 |
| **startupProbe** | 起動完了判定 |

### 設定管理

| リソース | 用途 |
|----------|------|
| **ConfigMap** | 設定ファイル |
| **Secret** | 機密情報（暗号化推奨） |
| **外部管理** | Secrets Manager連携 |

---

## セキュリティ

### ネットワーク

- **NetworkPolicy**: Pod間通信を制限
- **Service Mesh**: mTLSで通信暗号化

### Pod設定

```yaml
securityContext:
  runAsNonRoot: true
  readOnlyRootFilesystem: true
```

---

## 可観測性

| 観点 | ツール | メトリクス |
|------|--------|-----------|
| **ログ** | CloudWatch/ELK | 構造化ログ（JSON） |
| **メトリクス** | Prometheus/Grafana | RED（Rate/Errors/Duration） |
| **トレーシング** | Jaeger/X-Ray | 相関IDでリクエスト追跡 |

---

## デプロイ戦略

| 戦略 | 特徴 | パラメータ |
|------|------|-----------|
| **ローリング** | デフォルト、段階的更新 | maxSurge, maxUnavailable |
| **Blue/Green** | 2環境切替、即座ロールバック | - |
| **Canary** | 一部ユーザーに新版、段階展開 | - |

---

## ❌ アンチパターン vs ✅ ベストプラクティス

| アンチパターン | ベストプラクティス |
|---------------|-------------------|
| ❌ 分散モノリス（サービス間強依存） | ✅ 疎結合を維持 |
| ❌ 共有データベース | ✅ Database per Service |
| ❌ 過度な分割（機能ごとに細分化） | ✅ ビジネス境界で分割 |
| ❌ 同期通信の連鎖 | ✅ 非同期イベント駆動 |
| ❌ サービス間の直接DB参照 | ✅ API経由でのみアクセス |

---

## チェックリスト

- [ ] サービス境界はビジネス機能で決定
- [ ] APIは後方互換性を保つ
- [ ] Circuit Breakerで障害を前提とした設計
- [ ] 可観測性を最初から組み込む（ログ/メトリクス/トレーシング）
- [ ] Database per Service原則を遵守
- [ ] リソース requests/limits を設定
- [ ] ヘルスチェック（liveness/readiness）を実装
