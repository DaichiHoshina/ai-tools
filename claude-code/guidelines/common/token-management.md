# トークン管理ガイドライン

> **目的**: プロジェクト全体でClaudeトークン使用量を統一管理

---

## 予算ポリシー

| セッション種別 | 目安上限 | 警告閾値 |
|---------------|---------|---------|
| 単純タスク | 10K tokens | 80% |
| 中規模実装 | 50K tokens | 70% |
| 大規模設計 | 100K tokens | 60% |

## ツール使用制限

### Serena MCP

| パラメータ | デフォルト値 | 用途 |
|-----------|-------------|------|
| `max_answer_chars` | 10000 | 一般的な読み取り |
| `max_answer_chars` | 5000 | 探索・検索 |
| `max_answer_chars` | 20000 | 詳細分析時のみ |
| `depth` | 0-1 | シンボル取得時 |

### ファイル読み取り

| 操作 | 制限 |
|------|------|
| 全体読み込み | 500行以下のみ |
| 部分読み込み | `limit` 指定必須 |
| シンボル読み取り | `include_body=false` を優先 |

## 出力形式

| 項目 | 制限 | 根拠 |
|------|------|------|
| コード例 | 5行以内 | document-management.md |
| 説明文 | 1行まで | 簡潔性 |
| テーブル | 優先使用 | 情報密度 |
| 段落 | 最終手段 | トークン効率 |

## テクニック別コスト

| テクニック | コスト | 適用条件 |
|-----------|--------|---------|
| 圏論 | +2K | complexity >= 7 |
| 形式手法 | +1K | Concurrency/Security |
| PBT | +800 | difficulty >= 5 |
| Result型 | +500 | 常時 |
| 不変条件 | +300 | 状態管理 |

詳細: [technique-selection.md](./technique-selection.md)

## フェーズ別トークン予算

### セッションライフサイクル

```
起動フェーズ → 作業フェーズ → 完了フェーズ
  ~10K          11-27K           ~2K
```

| フェーズ | 内訳 | 予算 |
|---------|------|------|
| **起動** | CLAUDE.md(2K) + Hook検出(1K) + スキルロード(3-5K) + テクニック選択(0.5-2K) | ~10K |
| **作業(単純)** | 読み取り(3K) + 実装(5K) + 確認(2K) | ~12K |
| **作業(中規模)** | 読み取り(5K) + 設計(3K) + 実装(10K) + テスト(5K) + 確認(3K) | ~27K |
| **作業(大規模)** | Agent階層(5K) + 分解(5K) + 実装(30K) + テスト(10K) | ~50K |
| **完了** | 結果報告(1K) + 通知(0.5K) | ~2K |

### Progressive Disclosureによるトークン削減

| レベル | ロード対象 | コスト | 削減率 |
|--------|-----------|--------|--------|
| **Level 1** | skill.md frontmatter + 使用タイミング | ~200 tokens | 基準 |
| **Level 2** | skill.md 全体（概要+ルール） | ~1-3K tokens | - |
| **Level 3** | サブドキュメント（詳細実装例） | ~3-8K tokens | - |

**従来方式**: 全スキル一括ロード → ~48K tokens
**Progressive方式**: 必要なスキルのLevel 1のみ → ~2K tokens（**95%削減**）

### テクニック自動選択のトークンコスト

| タスク複雑度 | 選択テクニック数 | 追加コスト |
|-------------|----------------|-----------|
| 低 (complexity ≤ 3) | 2（必須のみ） | +700 |
| 中 (complexity 4-6) | 4-6 | +2-4K |
| 高 (complexity 7-9) | 7-9 | +5-8K |
| 最高 (complexity 10) | 10（全テクニック） | +8.5K |

## 節約パターン

### 推奨

```
✅ get_symbols_overview → find_symbol(depth=1) → find_symbol(include_body=true)
✅ Safe操作はメッセージなし
✅ 探索はTask(Explore)に委譲
```

### 非推奨

```
❌ ファイル全体読み込みの連続
❌ include_body=true の乱用
❌ 同一情報の再取得
```

## 警告レベル

| 使用率 | アクション |
|--------|----------|
| 60% | 節約モード開始 |
| 80% | 警告表示 |
| 90% | `/reload` 推奨 |

## チェックリスト

読み取り時:
- [ ] `max_answer_chars` 指定
- [ ] 必要最小限の `depth`
- [ ] `include_body=false` 優先

出力時:
- [ ] テーブル形式を優先
- [ ] コード5行以内
- [ ] 説明1行以内
