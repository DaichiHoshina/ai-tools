# プロンプトベストプラクティス

> **出典**: Boris氏（Claude Code開発者）のヒント#6「プロンプトレベル向上」

---

## 目次

- [1. Claudeに挑戦させる](#1-claudeに挑戦させる)
- [2. 洗練された解決策を要求](#2-洗練された解決策を要求)
- [3. 詳細な仕様を記述](#3-詳細な仕様を記述)
- [4. アンチパターン](#4-アンチパターン)
- [5. 参考リンク](#5-参考リンク)

---

## 1. Claudeに挑戦させる

### 原則

Claudeに「最もエレガントな解決策」「創造的なアプローチ」を要求することで、より洗練された回答を引き出す。

### 実例

#### 例1: アーキテクチャ設計

❌ **弱いプロンプト**:
```
ユーザー認証機能を実装してください。
```

✅ **強いプロンプト**:
```
ユーザー認証機能を実装してください。
以下の観点で最も優れた設計を提案してください:
- セキュリティ（トークン管理、暗号化）
- スケーラビリティ（同時アクセス対応）
- メンテナンス性（将来の拡張性）

複数の設計案を比較し、最もバランスの取れたアプローチを推奨してください。
```

**効果**: Claudeが複数案を比較検討し、トレードオフを明示した上で最適解を提案。

---

#### 例2: パフォーマンス最適化

❌ **弱いプロンプト**:
```
このコードを速くしてください。
```

✅ **強いプロンプト**:
```
このコードのパフォーマンスを最適化してください。
以下を考慮した最もエレガントな解決策を提案してください:
- 時間計算量（現状O(n²)をO(n)に改善）
- メモリ使用量（データ構造の見直し）
- 可読性（過度な最適化で読みにくくならない）

ベンチマーク結果の改善予想も示してください。
```

**効果**: 計算量分析、データ構造選択理由、可読性とのバランスを含む包括的な提案。

---

#### 例3: リファクタリング

❌ **弱いプロンプト**:
```
このコードをリファクタリングしてください。
```

✅ **強いプロンプト**:
```
このコードを以下の観点でリファクタリングしてください:
- SOLID原則に準拠
- 技術的負債の削減（重複コード排除）
- テスタビリティの向上（DIパターン活用）

最も効果の高いリファクタリング手法を提案し、
Before/Afterで改善内容を明示してください。
```

**効果**: 原則に基づいた設計改善、具体的なBefore/After比較、改善効果の定量化。

---

## 2. 洗練された解決策を要求

### 原則

「動けばいい」ではなく「パフォーマンス」「メンテナンス性」「拡張性」を両立した解決策を明示的に要求する。

### 実例

#### 例1: API設計

❌ **弱いプロンプト**:
```
商品検索APIを作ってください。
```

✅ **強いプロンプト**:
```
商品検索APIを設計してください。
以下を満たす洗練された設計を提案してください:
- パフォーマンス: 100万件データでも1秒以内にレスポンス
- 拡張性: フィルター条件・ソート順の追加が容易
- セキュリティ: SQLインジェクション対策、レート制限
- 運用性: ページング、エラーハンドリング、ログ設計

REST API設計のベストプラクティスに準拠してください。
```

**効果**: パフォーマンス要件、セキュリティ、運用性を考慮した包括的なAPI設計。

---

#### 例2: データベース設計

❌ **弱いプロンプト**:
```
注文テーブルを作ってください。
```

✅ **強いプロンプト**:
```
注文管理のデータベーススキーマを設計してください。
以下を両立する洗練された設計を提案してください:
- 正規化: 冗長性排除、整合性維持
- パフォーマンス: 頻繁なクエリに対する適切なインデックス設計
- スケーラビリティ: 年間100万注文に対応
- 監査性: 履歴管理、変更追跡

ER図とDDLを提示し、設計判断の理由を説明してください。
```

**効果**: 正規化理論、インデックス戦略、スケーラビリティ考慮を含む設計根拠の明示。

---

#### 例3: エラーハンドリング

❌ **弱いプロンプト**:
```
エラー処理を追加してください。
```

✅ **強いプロンプト**:
```
堅牢なエラーハンドリングを実装してください。
以下を満たす洗練された設計を提案してください:
- ユーザー体験: わかりやすいエラーメッセージ
- デバッグ性: スタックトレース、コンテキスト情報
- 運用性: ログレベル分類、監視アラート連携
- リカバリー: リトライ、フォールバック処理

言語のベストプラクティス（Go: error wrapping、TS: custom error class）に準拠してください。
```

**効果**: UX、デバッグ性、運用性を考慮した多層的なエラーハンドリング設計。

---

## 3. 詳細な仕様を記述

### 原則

曖昧さを排除し、制約条件・エッジケース・期待動作を明示することで、Claudeの推測を減らし、正確な実装を引き出す。

### 実例

#### 例1: バリデーション実装

❌ **弱いプロンプト**:
```
メールアドレスのバリデーションを実装してください。
```

✅ **強いプロンプト**:
```
メールアドレスのバリデーションを実装してください。

**仕様**:
- RFC 5322準拠の形式チェック
- 許可文字: a-z, A-Z, 0-9, .-_+
- ドメイン: 2文字以上のTLD必須（.co.jp等対応）
- 最大長: 254文字

**エッジケース**:
- "user+tag@example.com" → 許可（+記号対応）
- "user@localhost" → 拒否（TLD必須）
- 連続ドット ".." → 拒否
- 空文字、null、undefined → エラーメッセージ明示

**エラーメッセージ**:
- 形式不正: "メールアドレスの形式が正しくありません"
- 長すぎる: "メールアドレスは254文字以内で入力してください"

テストケース5件以上含めてください。
```

**効果**: RFC準拠、エッジケース網羅、明確なエラーメッセージを含む完全な実装。

---

#### 例2: ページング実装

❌ **弱いプロンプト**:
```
ページング機能を追加してください。
```

✅ **強いプロンプト**:
```
商品一覧APIにページング機能を追加してください。

**仕様**:
- パラメータ: `page` (1始まり), `limit` (デフォルト20, 最大100)
- レスポンス: items配列、total（総件数）、page、limit、hasNext

**制約**:
- `page < 1` → 400 Bad Request
- `limit > 100` → 自動的に100に制限
- `page * limit > total` → 空配列、hasNext: false

**パフォーマンス**:
- OFFSET使用禁止（大規模データで遅延）
- カーソルベースページング（lastId使用）

**エッジケース**:
- 0件の場合: items: [], total: 0, hasNext: false
- 最終ページ: hasNextをfalseに設定

OpenAPI仕様書も併せて作成してください。
```

**効果**: パラメータ制約、エラーハンドリング、パフォーマンス考慮を含む実用的な実装。

---

#### 例3: 状態遷移実装

❌ **弱いプロンプト**:
```
注文のステータス管理を実装してください。
```

✅ **強いプロンプト**:
```
注文のステータス管理を実装してください。

**状態定義**:
- DRAFT: 下書き（編集可能）
- PENDING: 確定（支払い待ち）
- PAID: 支払い済み（出荷準備中）
- SHIPPED: 出荷済み
- CANCELLED: キャンセル

**遷移ルール**:
- DRAFT → PENDING: items.length > 0 が条件
- PENDING → PAID: 決済成功時のみ
- PENDING → CANCELLED: 支払い前のみ可能
- PAID → SHIPPED: 在庫確保済みが条件
- PAID以降はCANCELLED不可（返金フロー別途）

**不正遷移時の動作**:
- エラー種別: InvalidStateTransitionError
- メッセージ: "注文ステータスを{現状態}から{次状態}に変更できません"
- ログ: WARN レベルで記録

**テスト**:
- 正常系: 各遷移パターン
- 異常系: 不正遷移、Guard条件未達

状態遷移図（Mermaid）も作成してください。
```

**効果**: 状態定義、遷移ルール、Guard条件、エラーハンドリングを含む堅牢な実装。

---

## 4. アンチパターン

### ❌ アンチパターン1: 曖昧な指示

```
これを良い感じにしてください。
```

**問題**: 「良い感じ」の定義が不明確。Claudeが推測で実装し、意図と乖離。

**改善**:
```
以下の基準で改善してください:
- 可読性: 変数名をビジネス用語に変更
- パフォーマンス: O(n²)をO(n log n)に改善
- 保守性: 200行の関数を責務ごとに分割
```

---

### ❌ アンチパターン2: 過度に短いプロンプト

```
バグ修正して
```

**問題**: バグの症状、再現手順、期待動作が不明。Claudeが推測で修正し、別のバグを生む可能性。

**改善**:
```
以下のバグを修正してください:

**症状**: ユーザー登録時に500エラー
**再現手順**:
1. /api/users に POST { email: "test@example.com", password: "pass" }
2. DB制約違反エラーが発生

**期待動作**: 既存メールの場合は 409 Conflict を返す
**ログ**: "duplicate key value violates unique constraint"

原因調査 → 修正 → テストケース追加まで実施してください。
```

---

### ❌ アンチパターン3: 制約条件の欠落

```
検索機能を追加してください。
```

**問題**: パフォーマンス要件、データ量、検索対象が不明。

**改善**:
```
商品検索機能を追加してください。

**前提**:
- 商品データ: 10万件
- 検索対象フィールド: name（商品名）、description（説明）、category（カテゴリ）
- 検索方式: 部分一致、大文字小文字区別なし

**パフォーマンス要件**:
- レスポンスタイム: 500ms以内
- 同時検索: 100リクエスト/秒

**技術選択**:
- 全文検索エンジン（Elasticsearch）使用
- OR条件で複数フィールド検索

実装 + 負荷テスト方法も提示してください。
```

---

## 5. 参考リンク

### Boris氏の公開情報
- [Claude Code公式ドキュメント](https://docs.anthropic.com/claude-code)
- Boris氏のヒント10選（元ソース）

### 関連ガイドライン
- `code-quality-design.md` - コード品質・設計原則
- `development-process.md` - 開発プロセス
- `testing-guidelines.md` - テスト作成基準

### 外部リソース
- [Prompt Engineering Guide](https://www.promptingguide.ai/)
- [Claude Best Practices](https://docs.anthropic.com/claude/docs/prompt-engineering)

---

## まとめ

| 項目 | ポイント |
|------|---------|
| **挑戦させる** | 「最もエレガントな」「創造的な」を明示 |
| **洗練要求** | パフォーマンス・保守性・拡張性を同時に要求 |
| **詳細仕様** | 制約・エッジケース・期待動作を明記 |
| **効果** | 実装品質30%向上、手戻り50%削減（Boris氏） |

**鉄則**: 「動けばいい」ではなく「なぜその設計か」をClaude に説明させることで、深い理解に基づく実装を引き出す。
