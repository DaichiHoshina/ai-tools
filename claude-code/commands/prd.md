---
allowed-tools: Read, Glob, Grep, Bash, WebFetch, WebSearch, AskUserQuestion, Task, mcp__serena__*, mcp__context7__*, mcp__confluence__*, mcp__jira__*
description: PRD作成 - 対話式で要件整理、数学的定式化（オプション）、10の専門家視点で厳格レビュー
---

# /prd - 要件定義・PRD作成コマンド

## 目的

複雑な要件（マイクロサービス連携、外部API）を整理し、あらゆる角度から抜け漏れを検出する。

---

## 実行フロー

### Phase 1: 情報収集（対話式）

AskUserQuestionで段階的に収集:

| Step | 質問 | 収集内容 |
|------|------|----------|
| 1 | 何を実現したいか？ | 目的、背景、課題 |
| 2 | どのサービスが関係？ | サービス一覧、役割 |
| 3 | 外部API・依存は？ | API仕様URL→WebFetchで取得 |
| 4 | 誰が使う？権限は？ | ロール、権限マトリクス |
| 5 | 主要フローは？ | 正常系、入力/出力 |

### Phase 1.5: 数学的定式化（複雑な要件の場合）

**AskUserQuestion**: 数学的に定式化しますか？（状態管理が複雑な場合に推奨）

「はい」の場合:

| セクション | 内容 |
|-----------|------|
| 用語集 | 5-15語、型を明記 |
| エンティティ | 属性、型、必須、制約 |
| 状態遷移 | 状態集合S、遷移表（現状態→イベント→次状態→Guard） |
| 操作（pre/post） | 事前条件、事後条件、発行イベント |
| 操作の合成 | パイプライン定義（`pay ∘ submit`等） |
| 不変条件 | 常に成立すべき制約 |
| 例外・境界条件 | エッジケース、期待動作 |
| 経路独立性 | 操作順序の可換性チェック |
| 目的関数 | 最適化基準（安全性、工数、運用コスト） |
| DDDマッピング | 定式化→実装への対応 |

#### 具体例: Order状態遷移（圧縮形式）

| 現状態 | イベント | 次状態 | Guard | pre/post | 不変条件 |
|--------|---------|--------|-------|----------|----------|
| Draft | submit() | Pending | items>0 | post: OrderSubmittedEvent | total=Σ(price×qty) |
| Pending | pay() | Paid | payment.success | - | Paid以降items変更不可 |
| Pending | cancel() | Cancelled | - | - | - |
| Paid | ship() | Shipped | inventory.available | - | - |

### Phase 2: PRD自動生成

収集情報から以下を構築:
- 概要（目的、背景、スコープ）
- ユーザーストーリー
- サービス依存関係（Mermaid図）
- 外部API仕様
- 変数マトリクス
- 状態遷移
- 受け入れ基準

### Phase 3: 多角的レビュー（10ペルソナ）

| ID | ペルソナ | チェック項目 |
|----|---------|-------------|
| SEC | セキュリティ | 認証、暗号化、インジェクション |
| PERF | パフォーマンス | N+1、ボトルネック、キャッシュ |
| SRE | 運用 | SPOF、障害検知、ロールバック |
| QA | テスト | エッジケース、境界値、再現性 |
| UX | UX | エラー表示、待機UI、導線 |
| DATA | データ | 履歴、監査ログ、整合性 |
| BIZ | ビジネス | ROI、優先度、MVP |
| LEGAL | 法務 | 個人情報、保持期間、同意 |
| ARCH | アーキテクチャ | 依存関係、拡張性、負債 |
| EXT | 外部連携 | フォールバック、リトライ、レート制限 |

**レビュー手法**:
- MECE（漏れ・重複検出）
- 状態遷移の完全性
- 条件分岐網羅（デシジョンテーブル）
- 矛盾検出
- 反証質問（失敗したら？同時に起きたら？0件/100万件なら？）

### Phase 4: 指摘一覧出力

```markdown
## レビュー結果

### ❌ Critical（必須対応）
1. [SEC] カード情報の暗号化方式が未定義
2. [ARCH] Payment Service障害時にハング

### ⚠️ Warning（推奨対応）
3. [PERF] 同時100決済でDBロック競合の可能性

### 💡 Info（検討推奨）
4. [UX] 決済処理中の待機UIが未定義
```

### Phase 5: 修正・承認

AskUserQuestion → 修正 or 承認 → `/plan`で実装計画 or `/dev`で実装開始

---

## 出力テンプレート

```markdown
# PRD: [機能名]
作成日: YYYY-MM-DD | ステータス: Draft / Reviewed / Approved

## 1. 概要
- 目的 / 背景・課題 / スコープ（In/Out）

## 2. ユーザー
- ターゲット / ストーリー / 権限マトリクス

## 3. システム構成
- サービス依存関係 / データフロー / 外部API仕様

## 4. 機能要件
- 変数マトリクス / 状態遷移 / ビジネスルール

## 4.5 定式化（複雑な要件の場合）
- 用語集 / エンティティ / 状態遷移 / 操作(pre/post)
- 操作の合成 / 不変条件 / 例外 / 経路独立性 / DDDマッピング

## 5. 非機能要件
- パフォーマンス / セキュリティ / 可用性 / 監視

## 6. 受け入れ基準
- [ ] 基準1 / - [ ] 基準2

## 7. レビュー結果
- Critical / Warning / Info

## 8. 次のアクション
- [ ] /plan / - [ ] /dev
```

---

## 注意事項

- **読み取り専用**: 実装はしない
- **外部API**: WebFetchで仕様取得
- **Jira/Confluence連携**: 既存チケット参照可
- **反復可能**: 指摘→修正→再レビュー
