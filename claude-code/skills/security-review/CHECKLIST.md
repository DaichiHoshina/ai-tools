# セキュリティチェックリスト

## コードレビュー用チェックリスト

### 入力検証

- [ ] すべてのユーザー入力が検証されているか
- [ ] ホワイトリスト方式で検証しているか
- [ ] 入力長の制限があるか
- [ ] 型チェックを実施しているか
- [ ] サーバーサイドで検証しているか（クライアント検証のみは不可）

### インジェクション対策

- [ ] SQLクエリはパラメータ化されているか
- [ ] 動的クエリで文字列連結を使用していないか
- [ ] ORMを使用している場合、生クエリに注意しているか
- [ ] OSコマンド実行を避けているか
- [ ] LDAPクエリはエスケープされているか
- [ ] XMLパーサーは外部エンティティを無効化しているか

### XSS対策

- [ ] 出力時にコンテキストに応じたエンコーディングをしているか
- [ ] テンプレートエンジンの自動エスケープを利用しているか
- [ ] innerHTMLではなくtextContentを使用しているか
- [ ] ユーザーHTMLを許可する場合、DOMPurify等でサニタイズしているか
- [ ] CSPヘッダーを設定しているか

### 認証

- [ ] パスワードは適切なアルゴリズム（bcrypt/Argon2）でハッシュしているか
- [ ] 弱いパスワードをチェックしているか
- [ ] ログイン試行を制限しているか
- [ ] アカウント列挙攻撃を防いでいるか
- [ ] MFAを実装しているか（重要機能）
- [ ] パスワードリセットは安全か

### セッション管理

- [ ] セッションIDは十分なエントロピーを持つか
- [ ] ログイン成功後にセッションIDを再生成しているか
- [ ] ログアウト時にセッションを破棄しているか
- [ ] セッションタイムアウトを実装しているか
- [ ] CookieにSecure, HttpOnly, SameSite属性があるか

### アクセス制御

- [ ] すべてのエンドポイントで認可チェックをしているか
- [ ] 直接オブジェクト参照を防いでいるか（IDOR）
- [ ] 権限昇格を防いでいるか
- [ ] 管理機能へのアクセスを制限しているか
- [ ] デフォルトで拒否（deny by default）しているか

### 暗号化

- [ ] 機密データはTLSで送信しているか
- [ ] 保存時の暗号化が必要なデータを暗号化しているか
- [ ] 暗号鍵はハードコードされていないか
- [ ] 安全なアルゴリズムを使用しているか（AES-256-GCM等）
- [ ] 証明書を適切に検証しているか

### エラー処理・ログ

- [ ] エラーメッセージに機密情報が含まれていないか
- [ ] スタックトレースを本番環境で表示していないか
- [ ] セキュリティイベントをログに記録しているか
- [ ] ログに機密情報を出力していないか
- [ ] ログの改ざんを防いでいるか

### ファイル操作

- [ ] アップロードファイルの種類を検証しているか
- [ ] ファイルサイズを制限しているか
- [ ] ファイル名をサニタイズしているか
- [ ] パストラバーサルを防いでいるか
- [ ] アップロードディレクトリは公開領域外か

---

## API セキュリティチェックリスト

### 認証・認可

- [ ] すべてのエンドポイントで認証が必要か確認したか
- [ ] JWTの署名を検証しているか
- [ ] JWTの有効期限を確認しているか
- [ ] APIキーは適切に保護されているか
- [ ] OAuthフローは正しく実装されているか

### レート制限

- [ ] レート制限を実装しているか
- [ ] レート制限は適切な閾値か
- [ ] レート制限はバイパスできないか

### 入力検証

- [ ] リクエストボディのサイズを制限しているか
- [ ] Content-Typeを検証しているか
- [ ] スキーマバリデーションを実装しているか

### レスポンス

- [ ] 不要なデータを返していないか
- [ ] エラーレスポンスに機密情報が含まれていないか
- [ ] セキュリティヘッダーを設定しているか

---

## インフラ・設定チェックリスト

### サーバー設定

- [ ] 不要なサービスを無効化しているか
- [ ] デフォルトアカウントを削除・変更しているか
- [ ] 最新のセキュリティパッチを適用しているか
- [ ] ディレクトリリスティングを無効化しているか
- [ ] サーバー情報ヘッダーを削除しているか

### HTTPヘッダー

- [ ] Content-Security-Policyを設定しているか
- [ ] X-Content-Type-Options: nosniffを設定しているか
- [ ] X-Frame-Options: DENYを設定しているか
- [ ] Strict-Transport-Securityを設定しているか
- [ ] Referrer-Policyを設定しているか

### HTTPS

- [ ] TLS 1.2以上を使用しているか
- [ ] 強力な暗号スイートのみを許可しているか
- [ ] 証明書は有効か
- [ ] HSTSを設定しているか

### 依存関係

- [ ] 既知の脆弱性がある依存関係はないか
- [ ] サポート切れのライブラリを使用していないか
- [ ] 依存関係を定期的に更新しているか

---

## 言語別チェックポイント

### JavaScript/TypeScript

- [ ] eval()を使用していないか
- [ ] new Function()を使用していないか
- [ ] innerHTMLを安全に使用しているか
- [ ] JSON.parse()で信頼できないデータを処理していないか
- [ ] prototypeポリューションを防いでいるか

### Python

- [ ] pickleで信頼できないデータをデシリアライズしていないか
- [ ] eval()/exec()を使用していないか
- [ ] os.system()よりsubprocessを使用しているか
- [ ] SQL Alchemyで生クエリに注意しているか

### Go

- [ ] database/sqlでプレースホルダを使用しているか
- [ ] html/templateで自動エスケープを利用しているか
- [ ] text/templateを使用していないか（XSS脆弱）
- [ ] exec.Commandで引数を適切に渡しているか

### Java

- [ ] PreparedStatementを使用しているか
- [ ] XMLパーサーでXXEを防いでいるか
- [ ] デシリアライゼーション脆弱性を防いでいるか
- [ ] Spring Securityを適切に設定しているか

---

## CWE 主要リファレンス

| CWE ID | 名称 | カテゴリ |
|--------|------|----------|
| CWE-20 | Improper Input Validation | 入力検証 |
| CWE-22 | Path Traversal | ファイル |
| CWE-77 | Command Injection | インジェクション |
| CWE-78 | OS Command Injection | インジェクション |
| CWE-79 | Cross-site Scripting (XSS) | XSS |
| CWE-89 | SQL Injection | インジェクション |
| CWE-200 | Information Exposure | 情報漏洩 |
| CWE-284 | Improper Access Control | アクセス制御 |
| CWE-287 | Improper Authentication | 認証 |
| CWE-311 | Missing Encryption | 暗号化 |
| CWE-352 | CSRF | CSRF |
| CWE-434 | Unrestricted File Upload | ファイル |
| CWE-502 | Deserialization | デシリアライズ |
| CWE-601 | Open Redirect | リダイレクト |
| CWE-611 | XML External Entity (XXE) | XML |
| CWE-798 | Hard-coded Credentials | 認証情報 |

---

## セキュリティテスト推奨ツール

### SAST（静的解析）

- Semgrep
- SonarQube
- CodeQL
- Bandit (Python)
- ESLint (security plugins)

### DAST（動的解析）

- OWASP ZAP
- Burp Suite
- Nikto

### 依存関係スキャン

- Snyk
- Dependabot
- npm audit / yarn audit
- OWASP Dependency-Check
