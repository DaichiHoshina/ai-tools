# 並列実行パターン

> **目的**: Developer Agent間の並列実行を最大化し、実装時間を短縮する

## 3つの実行パターン

### パターン1: 完全並列実行【最優先】

**条件**: タスク間に依存関係なし

```
┌─────────┬─────────┬─────────┬─────────┐
│  Dev1   │  Dev2   │  Dev3   │  Dev4   │
│ 同時開始│ 同時開始│ 同時開始│ 同時開始│
└─────────┴─────────┴─────────┴─────────┘
     │         │         │         │
     └─────────┴─────────┴─────────┘
                    │
               全員完了後
                    ↓
               統合検証
```

**特徴**:
- 1メッセージで全Developer同時起動
- 最短時間で完了
- 最も推奨されるパターン

**適用例**:
- 異なるファイルへの変更
- 独立したコンポーネント
- 異なるレイヤー（FE/BE/Test）

### パターン2: 段階的実行【次善】

**条件**: 一部に依存関係あり

```
Stage 1:
┌─────────┬─────────┐
│  Dev1   │  Dev2   │  ← 並列
└─────────┴─────────┘
     │         │
     └────┬────┘
          │ Stage 1完了待ち
          ↓
Stage 2:
┌─────────┬─────────┐
│  Dev3   │  Dev4   │  ← 並列
└─────────┴─────────┘
     │         │
     └────┬────┘
          │
          ↓
     統合検証
```

**特徴**:
- 各Stage内では並列実行
- Stage間は順次実行
- 依存関係を尊重しつつ最大限並列化

**適用例**:
- 型定義 → 実装（Stage分割）
- API → クライアント（Stage分割）
- DB設計 → アプリ実装（Stage分割）

### パターン3: 順次実行【例外的】

**条件**: 強い依存関係あり

```
Dev1 → Dev2 → Dev3 → Dev4
 │       │       │       │
 └───────┴───────┴───────┘
         直列実行
```

**特徴**:
- 各Developerが前のDeveloperの完了を待つ
- 最も時間がかかる
- 可能な限り避ける

**適用例**:
- 同一ファイルへの変更
- 強い順序依存

**重要**: このパターンが必要な場合は**設計見直しを検討**

## パターン判定フローチャート

```
タスク分析
    │
    ▼
┌─────────────────────────────┐
│ 同一ファイルへの変更あり?   │
└─────────────────────────────┘
    │No              │Yes
    ▼                ▼
┌─────────────┐  ┌─────────────┐
│依存関係あり?│  │順次実行     │
└─────────────┘  │または設計   │
    │No   │Yes   │見直し       │
    ▼     ▼      └─────────────┘
┌─────┐ ┌─────┐
│完全 │ │段階的│
│並列 │ │実行  │
└─────┘ └─────┘
```

## 依存関係の種類

### 並列可能な依存関係

| 関係 | 理由 |
|------|------|
| 異なるファイル | 物理的に独立 |
| 異なるディレクトリ | 物理的に独立 |
| FE / BE | 論理的に独立（APIインターフェースで結合） |
| 実装 / テスト | テストは実装後でも並列可（モック使用） |

### 段階的実行が必要な依存関係

| 関係 | Stage分割 |
|------|----------|
| 型定義 → 実装 | Stage1: 型定義、Stage2: 実装 |
| API → クライアント | Stage1: API、Stage2: クライアント |
| 共通処理 → 使用箇所 | Stage1: 共通処理、Stage2: 使用箇所 |

### 順次実行が必要な依存関係

| 関係 | 対応 |
|------|------|
| 同一ファイル改修 | 設計見直し or 順次 |
| 複雑なリファクタ | タスク再分割を検討 |

## 1メッセージ同時起動の実装

Manager AgentはClaude Codeに以下を指示:

```markdown
## 実行指示

以下のDeveloper Agentsを**1メッセージで同時に**起動してください：

- Developer 1 (dev1): Backend API実装
- Developer 2 (dev2): Frontend実装
- Developer 3 (dev3): テスト作成
```

Claude Codeは1つのメッセージで複数のTask tool callを発行:

```
[Task tool call 1: dev1]
[Task tool call 2: dev2]
[Task tool call 3: dev3]
```

## ベストプラクティス

### 1. 依存関係の最小化

- 明確なインターフェース定義
- 疎結合な設計
- 共有状態の排除

### 2. 適切なタスク粒度

- 大きすぎ: 並列化できない
- 小さすぎ: オーバーヘッド増加
- **推奨**: 1-4時間程度の作業量

### 3. 段階的実行の最適化

```
悪い例:
Stage1: Dev1
Stage2: Dev2
Stage3: Dev3
Stage4: Dev4  ← 実質順次実行

良い例:
Stage1: Dev1, Dev2 並列
Stage2: Dev3, Dev4 並列  ← 並列性維持
```

### 4. 同一ファイル改修の回避

```
悪い設計:
- Dev1: user.ts の認証部分
- Dev2: user.ts のプロフィール部分
→ 衝突の可能性

良い設計:
- Dev1: auth.ts（認証）
- Dev2: profile.ts（プロフィール）
→ 完全並列可能
```

## 関連ドキュメント

- `claude-code/agents/manager-agent.md` - タスク配分の詳細
- `claude-code/references/AI-THINKING-ESSENTIALS.md` - 複雑度判定
