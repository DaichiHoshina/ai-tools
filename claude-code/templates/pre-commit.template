#!/bin/bash
# Pre-commit hook for ai-tools
# Runs shellcheck on all shell scripts before commit

set -e

echo "üîç Running pre-commit checks..."

# Check if shellcheck is installed
if ! command -v shellcheck &> /dev/null; then
    echo "‚ö†Ô∏è  shellcheck not found. Installing..."
    if command -v brew &> /dev/null; then
        brew install shellcheck
    else
        echo "‚ùå Please install shellcheck manually:"
        echo "   macOS: brew install shellcheck"
        echo "   Ubuntu: sudo apt-get install shellcheck"
        exit 1
    fi
fi

# Get list of staged shell scripts
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sh$' || true)

if [ -z "$STAGED_SH_FILES" ]; then
    echo "‚úÖ No shell scripts to check"
    exit 0
fi

echo "üìù Checking shell scripts:"
echo "$STAGED_SH_FILES" | sed 's/^/  - /'

# Run shellcheck on staged files
SHELLCHECK_FAILED=0
for file in $STAGED_SH_FILES; do
    if [ -f "$file" ]; then
        echo "  Checking $file..."
        if ! shellcheck --severity=warning "$file"; then
            SHELLCHECK_FAILED=1
        fi
    fi
done

if [ $SHELLCHECK_FAILED -eq 1 ]; then
    echo ""
    echo "‚ùå Shellcheck failed. Please fix the issues above."
    echo "   To skip this check (not recommended), use: git commit --no-verify"
    exit 1
fi

echo "‚úÖ All checks passed!"
exit 0
