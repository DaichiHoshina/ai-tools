name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      
      - name: Run shellcheck on scripts
        run: |
          find claude-code -name "*.sh" -type f -print0 | \
            xargs -0 shellcheck --severity=warning || true
          
      - name: Run shellcheck on hooks (strict)
        run: |
          shellcheck claude-code/hooks/*.sh

  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Bash syntax check
        run: |
          find claude-code -name "*.sh" -type f -exec bash -n {} \;
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: JavaScript syntax check
        run: |
          node --check claude-code/statusline.js

  hooks-test:
    name: Hooks Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Test user-prompt-submit hook
        run: |
          bash claude-code/hooks/test-user-prompt-submit.sh
      
      - name: Test pre-skill-use hook
        run: |
          bash claude-code/hooks/test-pre-skill-use.sh
      
      - name: Test session-start hook
        run: |
          echo '{"mcp_servers": {"serena": {}}}' | \
            bash claude-code/hooks/session-start.sh

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for secrets in code
        run: |
          # Check for potential secret leaks
          ! grep -r "password\s*=\s*['\"]" claude-code/ --include="*.sh" --include="*.md"
          ! grep -r "api_key\s*=\s*['\"]" claude-code/ --include="*.sh" --include="*.md"
          ! grep -r "secret\s*=\s*['\"]" claude-code/ --include="*.sh" --include="*.md"
      
      - name: Verify security functions exist
        run: |
          test -f claude-code/lib/security-functions.sh
          grep -q "escape_for_sed" claude-code/lib/security-functions.sh
          grep -q "secure_token_input" claude-code/lib/security-functions.sh

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli
      
      - name: Run markdownlint
        run: |
          markdownlint claude-code/**/*.md --ignore node_modules || true

  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [shellcheck, syntax-check, hooks-test, security-check, markdown-lint]
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate quality metrics
        run: |
          echo "## Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Shell scripts: $(find claude-code -name '*.sh' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Markdown files: $(find claude-code -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Skills: $(ls -1 claude-code/skills | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Commands: $(ls -1 claude-code/commands | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Agents: $(ls -1 claude-code/agents | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Hooks: $(ls -1 claude-code/hooks/*.sh | wc -l)" >> $GITHUB_STEP_SUMMARY
